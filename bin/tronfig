#!/usr/bin/env python
from __future__ import with_statement
import logging
import os
import tempfile
import subprocess
import sys

from tron.commands import cmd_utils
from tron.commands.client import Client
from tron.config import config_parse
from tron.config import schema, manager, ConfigError
from getpass import getuser

log = logging.getLogger('tronfig')
TRON_LOG = '/var/log/tron/tron.log'

def set_options_from_args(options, args):
    if args and args[-1] == '-':
        options.from_stdin = True
        args = args[:-1]
    else:
        options.from_stdin = False

    options.config_name = args[0] if args else schema.MASTER_NAMESPACE


def parse_options():
    usage  = "usage: %prog [<name>] [options] [-]"
    parser = cmd_utils.build_option_parser(usage)

    parser.add_option("-p", "--print", action="store_true", dest="print_config",
                      help="Print config to stdout, rather than uploading")
    parser.add_option("-n", "--no-header", action="store_true", default=False,
                      help="Print named config without a header")

    options, args = parser.parse_args()
    set_options_from_args(options, args)
    return options


def upload_config(client, config_name, contents, config_hash):
    response = client.config(config_name,
                             config_data=contents, config_hash=config_hash)
    if 'error' in response:
        log.error(response['error'])
        return False
    print >>sys.stderr, "Configuration uploaded successfully"
    return True


def edit_config(contents):
    fi = tempfile.NamedTemporaryFile(suffix='.yaml')
    fi.write(contents)
    fi.flush()

    editor = os.getenv('EDITOR') or os.getenv('VISUAL') or 'vim'
    while os.system("%s %s" % (editor, fi.name)):
        response = raw_input(
            "Editor returned an error. Continue editing? (y/n): ")
        if response[:1].lower() == 'n':
            return

    with open(fi.name) as upload_file:
        return upload_file.read()


def validate(config_name, config_content):
    try:
        config_data = manager.from_string(config_content)
        config_parse.validate_fragment(config_name, config_data)
        return True
    except ConfigError, e:
        log.error(e)


def print_config(client, config_name, no_header):
    print client.config(config_name, no_header=no_header)['config']


def update_from_stdin(client, config_name):
    config_content = sys.stdin.read()
    config_hash = client.config(config_name)['hash']
    if validate(config_name, config_content):
        if upload_config(client, config_name, config_content, config_hash):
            return
    raise SystemExit("tronfig failed")


def update_with_editor(client, config_name):
    namespaces = client.home()['namespaces']
    if config_name not in namespaces:
        raise SystemExit("Available namespaces are: %s" % '\n'.join(namespaces))

    if not sys.stdout.isatty():
        raise SystemExit("No editing possible.")

    response        = client.config(config_name)
    config_content  = response['config']
    config_hash     = response['hash']
    username        = getuser()
    with open(TRON_LOG, "a") as tron_log:
        tron_log.write("tronfig editing by %s" % username)
    while True:
        orig_content = config_content
        config_content = edit_config(config_content)
        if not config_content:
            log.warn("Cancelling edit.")
            return

        if orig_content == config_content:
            print >> sys.stderr, "unchanged"
            return

        if validate(config_name, config_content):
            if upload_config(client, config_name, config_content, config_hash):
                print >>sys.stderr, "uploading to github..."
                output = []
                try:
                    p = subprocess.Popen("python /var/lib/tron/tronfig.py %s %s" % (username, config_name),
                        shell=True, stdout=subprocess.PIPE, stderr=subprocess.STDOUT)
                    while True:
                        out = p.stdout.readline()

                        if not out and p.poll() is not None:
                            break

                        if out:
                            output.append(out)
                            print out.strip()

                    if p.wait() != 0:
                        raise Exception("Process returned non-zero response %d" % p.returncode)

                    print >>sys.stderr, "success - http://tron:8089/"
                except:
                    print >>sys.stderr, "failed (please see David): %s" % ''.join(output)
                return

        response = raw_input(
            "There are errors in your configuration. Continue editing? (y/n): ")
        if response[:1].lower() == 'n':
            return


if __name__ == '__main__':
    options = parse_options()
    cmd_utils.setup_logging(options)
    cmd_utils.load_config(options)
    client = Client(options.server)
    config_name = options.config_name

    if options.print_config:
        print_config(client, config_name, options.no_header)

    elif options.from_stdin:
        update_from_stdin(client, config_name)

    else:
        update_with_editor(client, config_name)
